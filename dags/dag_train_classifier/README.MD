# ğŸ“‹ Document Classifier Training DAG

> **DAG ID:** `com.train.document_classifier`  
> **PhiÃªn báº£n:** 1.0.0  
> **Cáº­p nháº­t:** ThÃ¡ng 1/2026

---

## ğŸ“– Giá»›i thiá»‡u

Hiá»‡n táº¡i, viá»‡c nhiá»u loáº¡i giáº¥y tá» doanh nghiá»‡p chÆ°a Ä‘Æ°á»£c phÃ¢n loáº¡i tá»± Ä‘á»™ng gÃ¢y khÃ³ khÄƒn trong quy trÃ¬nh xá»­ lÃ½ tÃ i liá»‡u. DAG nÃ y Ä‘Æ°á»£c thiáº¿t káº¿ Ä‘á»ƒ **huáº¥n luyá»‡n mÃ´ hÃ¬nh phÃ¢n loáº¡i hÃ¬nh áº£nh** nháº­n diá»‡n cÃ¡c loáº¡i giáº¥y tá» phá»• biáº¿n nhÆ°:

- ğŸªª CCCD (CÄƒn cÆ°á»›c cÃ´ng dÃ¢n) cÃ¡c phiÃªn báº£n
- ğŸ†” CMND (Chá»©ng minh nhÃ¢n dÃ¢n)
- ğŸ“„ Giáº¥y khai sinh
- ğŸ“‘ CÃ¡c loáº¡i giáº¥y tá» khÃ¡c...

### VÃ­ dá»¥ hÃ¬nh áº£nh giáº¥y tá»

![VÃ­ dá»¥ giáº¥y tá»](image/example1.png)
---

## ğŸ¯ Má»¥c tiÃªu

| Má»¥c tiÃªu | MÃ´ táº£ |
|----------|-------|
| **Tá»± Ä‘á»™ng phÃ¢n loáº¡i** | Nháº­n diá»‡n loáº¡i giáº¥y tá» tá»« áº£nh chá»¥p/scan |
| **Äá»™ chÃ­nh xÃ¡c cao** | Äáº¡t >95% accuracy trÃªn táº­p validation |
| **Tá»‘c Ä‘á»™ inference nhanh** | <50ms/áº£nh trÃªn CPU |
| **Dá»… triá»ƒn khai** | Export model dáº¡ng inference Ä‘á»ƒ dÃ¹ng trong production |

---

## ğŸ“‚ Cáº¥u trÃºc Dataset

```
dags/data/
â”œâ”€â”€ cccd_12_number_back/     # CCCD 12 sá»‘ - Máº·t sau
â”œâ”€â”€ cccd_12_number_front/    # CCCD 12 sá»‘ - Máº·t trÆ°á»›c
â”œâ”€â”€ cccd_new_back/           # CCCD má»›i - Máº·t sau
â”œâ”€â”€ cccd_new_front/          # CCCD má»›i - Máº·t trÆ°á»›c
â”œâ”€â”€ cccd_qr_back/            # CCCD cÃ³ QR - Máº·t sau
â”œâ”€â”€ cccd_qr_front/           # CCCD cÃ³ QR - Máº·t trÆ°á»›c
â”œâ”€â”€ cmnd_12_number_front/    # CMND 12 sá»‘ - Máº·t trÆ°á»›c
â”œâ”€â”€ cmnd_back/               # CMND - Máº·t sau
â”œâ”€â”€ cmnd_front/              # CMND - Máº·t trÆ°á»›c
â””â”€â”€ giay_khai_sinh/          # Giáº¥y khai sinh
```

### YÃªu cáº§u dá»¯ liá»‡u

- âœ… Má»—i folder lÃ  **má»™t nhÃ£n (class)**
- âœ… Chá»©a cÃ¡c file áº£nh Ä‘á»‹nh dáº¡ng: `.jpg`, `.jpeg`, `.png`, `.bmp`, `.webp`
- âœ… TÃªn folder = tÃªn class (khÃ´ng dáº¥u, dÃ¹ng underscore)
- âœ… Khuyáº¿n nghá»‹: **>100 áº£nh/class** Ä‘á»ƒ model há»c tá»‘t

---

## ğŸ§  Kiáº¿n trÃºc Model

### MobileNetV3 Small

Model sá»­ dá»¥ng Ä‘á»ƒ fine-tune lÃ  **MobileNetV3 Small (x1.0)** - má»™t kiáº¿n trÃºc CNN hiá»‡n Ä‘áº¡i, tá»‘i Æ°u cho thiáº¿t bá»‹ edge/mobile.

| ThÃ´ng sá»‘ | GiÃ¡ trá»‹ |
|----------|---------|
| **Backbone** | MobileNetV3 Small |
| **Input size** | 224 Ã— 224 Ã— 3 |
| **Parameters** | ~2.5M |
| **FLOPs** | ~65M |
| **ImageNet Top-1** | ~67.4% |

### âœ… Æ¯u Ä‘iá»ƒm

| Æ¯u Ä‘iá»ƒm | Chi tiáº¿t |
|---------|----------|
| **ğŸš€ Nháº¹ vÃ  nhanh** | Sá»‘ tham sá»‘ Ã­t, FLOPs tháº¥p, phÃ¹ há»£p mobile/edge device, Raspberry Pi |
| **ğŸ¯ Generalize tá»‘t** | Pretrain trÃªn ImageNet, trÃ­ch xuáº¥t Ä‘áº·c trÆ°ng hiá»‡u quáº£ cho dataset nhá»/vá»«a |
| **ğŸ“¦ Dá»… triá»ƒn khai** | Há»— trá»£ sáºµn trong PaddlePaddle, PyTorch, TensorFlow. Export ONNX, TFLite dá»… dÃ ng |

### âš ï¸ Háº¡n cháº¿

| Háº¡n cháº¿ | Chi tiáº¿t |
|---------|----------|
| **ğŸ“‰ Accuracy tháº¥p hÆ¡n** | So vá»›i ResNet50, EfficientNet-B3 do Æ°u tiÃªn tá»‘c Ä‘á»™ |
| **ğŸ” Biá»ƒu diá»…n háº¡n cháº¿** | CÃ³ thá»ƒ underfit vá»›i bÃ i toÃ¡n fine-grained hoáº·c nhiá»u class phá»©c táº¡p |

### ğŸ’¡ Khi nÃ o nÃªn dÃ¹ng?

- âœ… á»¨ng dá»¥ng mobile/IoT, yÃªu cáº§u latency tháº¥p, real-time
- âœ… Dataset vá»«a pháº£i (10-100 classes), áº£nh khÃ´ng quÃ¡ phá»©c táº¡p
- âœ… Æ¯u tiÃªn tá»‘c Ä‘á»™ vÃ  tÃ i nguyÃªn hÆ¡n Ä‘á»™ chÃ­nh xÃ¡c tuyá»‡t Ä‘á»‘i

---

## âš™ï¸ Cáº¥u hÃ¬nh Training

```python
# Model Config
MODEL_CONFIG = {
    'backbone': 'mobilenet_v3_small',
    'image_size': 224,
    'pretrained': True,
}

# Training Config
TRAIN_CONFIG = {
    'batch_size': 32,
    'epochs': 20,
    'learning_rate': 0.001,
    'optimizer': 'Adam',
    'lr_scheduler': 'CosineAnnealingDecay',
    'warmup_epochs': 2,
}

# Data Split
DATA_SPLIT = {
    'train': 0.8,   # 80%
    'val': 0.15,    # 15%
    'test': 0.05,   # 5%
}
```

---

## ğŸ”„ DAG Pipeline

DAG gá»“m **4 tasks** cháº¡y tuáº§n tá»±:

```
prepare_dataset >> train_model >> evaluate_model >> export_inference_model
```

---

### ğŸ“Š Task 1: Prepare Dataset

Chuáº©n bá»‹ vÃ  chia dá»¯ liá»‡u thÃ nh train/val/test sets.

**Chá»©c nÄƒng:**

- QuÃ©t thÆ° má»¥c data, xÃ¡c Ä‘á»‹nh classes tá»« tÃªn folder
- Äáº¿m sá»‘ áº£nh má»—i class, kiá»ƒm tra cÃ¢n báº±ng
- Random split theo tá»· lá»‡ 80/15/5
- Táº¡o file `train.txt`, `val.txt`, `test.txt`

![Prepare Dataset](image/dag_step1.png)
---

### ğŸ‹ï¸ Task 2: Train Model

Huáº¥n luyá»‡n model MobileNetV3 vá»›i dá»¯ liá»‡u Ä‘Ã£ chuáº©n bá»‹.

**Chá»©c nÄƒng:**

- Load pretrained weights tá»« ImageNet
- Replace classifier layer cho sá»‘ classes má»›i
- Training vá»›i data augmentation (resize, flip, rotate, color jitter)
- Learning rate scheduler vá»›i warmup
- Save best model theo validation accuracy
- Log metrics qua má»—i epoch

![Train Model](image/dag_step2.png)

---

### ğŸ“ˆ Task 3: Evaluate Model

ÄÃ¡nh giÃ¡ model trÃªn táº­p test.

**Chá»©c nÄƒng:**

- Load best checkpoint
- Inference trÃªn toÃ n bá»™ test set
- TÃ­nh toÃ¡n metrics: Accuracy, Precision, Recall, F1-score
- Táº¡o Confusion Matrix
- PhÃ¢n tÃ­ch per-class performance
- Xuáº¥t bÃ¡o cÃ¡o evaluation

![Evaluate Model](image/dag_step3.png)

---

### ğŸ’¾ Task 4: Export Inference Model

Export model sang Ä‘á»‹nh dáº¡ng inference Ä‘á»ƒ deploy.

**Chá»©c nÄƒng:**

- Load best checkpoint
- Chuyá»ƒn Ä‘á»•i sang static graph
- Export `.pdmodel` + `.pdiparams`
- Táº¡o `config.json` vá»›i preprocessing params
- Táº¡o `label_map.json` mapping index â†’ class name

![Save Model](image/dag_step4.png)

---

## ğŸ“ Output Structure

```
models/doc_classifier/
â”œâ”€â”€ dataset/
â”‚   â”œâ”€â”€ train.txt          # Training file list
â”‚   â”œâ”€â”€ val.txt            # Validation file list
â”‚   â”œâ”€â”€ test.txt           # Test file list
â”‚   â””â”€â”€ class_info.json    # Class statistics
â”‚
â”œâ”€â”€ checkpoints/
â”‚   â”œâ”€â”€ best_model.pdparams    # Best model weights
â”‚   â”œâ”€â”€ final_model.pdparams   # Final epoch weights
â”‚   â””â”€â”€ training_history.json  # Loss/accuracy per epoch
â”‚
â”œâ”€â”€ evaluation/
â”‚   â”œâ”€â”€ report.json        # Detailed metrics
â”‚   â”œâ”€â”€ confusion_matrix.png
â”‚   â””â”€â”€ per_class_metrics.json
â”‚
â””â”€â”€ inference/
    â”œâ”€â”€ model.pdmodel      # Inference model
    â”œâ”€â”€ model.pdiparams    # Model parameters
    â”œâ”€â”€ config.json        # Preprocessing config
    â””â”€â”€ label_map.json     # Class mapping
```

---

## ğŸš€ CÃ¡ch sá»­ dá»¥ng Model

### Command Line

```bash
cd services
python doc_classifier.py path/to/image.jpg
```

### Python Code

```python
from doc_classifier import create_classifier

# Khá»Ÿi táº¡o classifier
classifier = create_classifier()

# Predict
result = classifier.predict("image.jpg")
print(result)
# {
#     'class': 'cccd_qr_front',
#     'label': 'CCCD QR - Máº·t trÆ°á»›c',
#     'confidence': 0.98,
#     'top_k': [...]
# }

# Batch predict
results = classifier.predict_batch(["img1.jpg", "img2.jpg"])
```

---

## ğŸ“Š Káº¿t quáº£ Training

| Metric | GiÃ¡ trá»‹ |
|--------|---------|
| **Best Epoch** | 5 |
| **Best Accuracy** | **99.31%** |
| **Total Classes** | 10 |
| **Total Images** | ~3,938 |
| **Training Time** | ~10 phÃºt |

---

## ğŸ“ LÆ°u Ã½

1. **GPU**: Training há»— trá»£ cáº£ CPU vÃ  GPU. Vá»›i GPU sáº½ nhanh hÆ¡n ~5-10x
2. **Data Balance**: NÃªn cÃ³ sá»‘ lÆ°á»£ng áº£nh tÆ°Æ¡ng Ä‘Æ°Æ¡ng giá»¯a cÃ¡c class
3. **Augmentation**: CÃ³ thá»ƒ tÃ¹y chá»‰nh trong config Ä‘á»ƒ tÄƒng Ä‘á»™ Ä‘a dáº¡ng
4. **Early Stopping**: Model tá»± lÆ°u checkpoint tá»‘t nháº¥t theo val accuracy

---

## ğŸ”— LiÃªn káº¿t

- [PaddlePaddle Documentation](https://www.paddlepaddle.org.cn/documentation/docs/en/guides/index_en.html)
- [MobileNetV3 Paper](https://arxiv.org/abs/1905.02244)
- [Apache Airflow](https://airflow.apache.org/)
